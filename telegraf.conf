# Файл: telegraf.conf (финальная исправленная версия)

[agent]
  interval = "10s"
  flush_interval = "10s"

# Вход: слушаем Mosquitto
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [ "bakery/#" ]
  
  # Указываем, что данные в формате JSON
  data_format = "json"

  # ===================== КЛЮЧЕВОЕ ИЗМЕНЕНИЕ =====================
  # Говорим, из какого JSON-поля брать название самой метрики.
  # Это правильный и единственный параметр, который нам здесь нужен.
  json_name_key = "measurement"
  # =================================================================
  # Telegraf автоматически превратит другие строковые поля ("device_id", "units") в теги.

# Выход: пишем в InfluxDB
[[outputs.influxdb_v2]]
  urls = ["http://digitalegiz-influx:8086"]
  token = "65ZYvTnE-wHPfW9wjn4N4es6_rsLhJYQlIOyYQKQJxrL8bOdOFEMF300q9o9_Geo9-HlLzag4s0L2MQm11pV4Q==" # <-- Убедитесь, что токен на месте
  organization = "dtkaznu"
  bucket = "iot-data"
  